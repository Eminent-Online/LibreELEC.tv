From 0dd67e8c408475dbff3e6d44965eeb1b9f279939 Mon Sep 17 00:00:00 2001
From: cdu13a <cdu13a@gmail.com>
Date: Tue, 24 Sep 2019 19:50:30 -0400
Subject: [PATCH 41/43] AMLUtils: add custom video mode support

support custom_mode and disp_add
---
 xbmc/utils/AMLUtils.cpp | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/xbmc/utils/AMLUtils.cpp b/xbmc/utils/AMLUtils.cpp
index f1292b5..4ad6fe9 100644
--- a/xbmc/utils/AMLUtils.cpp
+++ b/xbmc/utils/AMLUtils.cpp
@@ -485,16 +485,24 @@ bool aml_set_native_resolution(const RESOLUTION_INFO &res, std::string framebuff
 
 bool aml_probe_resolutions(std::vector<RESOLUTION_INFO> &resolutions)
 {
-  std::string valstr, vesastr, dcapfile;
+  std::string valstr, addstr, dcapfile, daddfile;
   dcapfile = CSpecialProtocol::TranslatePath("special://home/userdata/disp_cap");
+  daddfile = CSpecialProtocol::TranslatePath("special://home/userdata/disp_add");
 
   if (SysfsUtils::GetString(dcapfile, valstr) < 0)
   {
     if (SysfsUtils::GetString("/sys/class/amhdmitx/amhdmitx0/disp_cap", valstr) < 0)
       return false;
 
-    if (SysfsUtils::GetString("/sys/class/amhdmitx/amhdmitx0/vesa_cap", vesastr) == 0)
-      valstr += "\n" + vesastr;
+    if (SysfsUtils::GetString("/sys/class/amhdmitx/amhdmitx0/vesa_cap", addstr) == 0)
+      valstr += "\n" + addstr;
+
+    if (SysfsUtils::GetString("/sys/class/amhdmitx/amhdmitx0/custom_mode", addstr) == 0)
+      valstr += "\n" + addstr;
+
+    if (SysfsUtils::GetString(daddfile, addstr) == 0)
+      valstr += "\n" + addstr;
+
   }
   std::vector<std::string> probe_str = StringUtils::Split(valstr, "\n");
 
@@ -543,8 +551,15 @@ bool aml_set_display_resolution(const RESOLUTION_INFO &res, std::string framebuf
 {
   std::string mode = res.strId.c_str();
   std::string cur_mode;
+  std::string custom_mode;
 
   SysfsUtils::GetString("/sys/class/display/mode", cur_mode);
+  SysfsUtils::GetString("/sys/class/amhdmitx/amhdmitx0/custom_mode", custom_mode);
+
+  if (custom_mode == mode)
+  {
+    mode = "custombuilt";
+  }
 
   if (aml_has_frac_rate_policy())
   {
-- 
2.7.4

