From ca9bd0fadc0f95bc7593e2da6ac1f7ab4e037757 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Sun, 6 Aug 2017 20:01:57 +0200
Subject: [PATCH 1/2] AEChannelInfo: Add IsLayoutValid method

---
 xbmc/cores/AudioEngine/Utils/AEChannelInfo.cpp | 24 ++++++++++++++++++++++++
 xbmc/cores/AudioEngine/Utils/AEChannelInfo.h   |  2 ++
 2 files changed, 26 insertions(+)

diff --git a/xbmc/cores/AudioEngine/Utils/AEChannelInfo.cpp b/xbmc/cores/AudioEngine/Utils/AEChannelInfo.cpp
index 4f77c04fe79e..636d7287145b 100644
--- a/xbmc/cores/AudioEngine/Utils/AEChannelInfo.cpp
+++ b/xbmc/cores/AudioEngine/Utils/AEChannelInfo.cpp
@@ -259,6 +259,30 @@ CAEChannelInfo::operator std::string() const
   return s;
 }
 
+bool CAEChannelInfo::IsChannelValid(const unsigned int pos)
+{
+  assert(pos < m_channelCount);
+  bool isValid = false;
+  if (m_channels[pos] > AE_CH_NULL && m_channels[pos] < AE_CH_UNKNOWN1)
+    isValid = true;
+
+  return isValid;
+}
+
+bool CAEChannelInfo::IsLayoutValid()
+{
+  if (m_channelCount == 0)
+    return false;
+
+  for (unsigned int i = 0; i < m_channelCount; ++i)
+  {
+    // we need at least one valid channel
+    if (IsChannelValid(i))
+      return true;
+  }
+  return false;
+}
+
 const char* CAEChannelInfo::GetChName(const enum AEChannel ch)
 {
   assert(ch >= 0 && ch < AE_CH_MAX);
diff --git a/xbmc/cores/AudioEngine/Utils/AEChannelInfo.h b/xbmc/cores/AudioEngine/Utils/AEChannelInfo.h
index 4151776eabe0..1ed9578781c1 100644
--- a/xbmc/cores/AudioEngine/Utils/AEChannelInfo.h
+++ b/xbmc/cores/AudioEngine/Utils/AEChannelInfo.h
@@ -51,6 +51,8 @@ class CAEChannelInfo {
   inline unsigned int Count() const { return m_channelCount; }
   static const char* GetChName(const enum AEChannel ch);
   bool HasChannel(const enum AEChannel ch) const;
+  bool IsChannelValid(const unsigned int pos);
+  bool IsLayoutValid();
   bool ContainsChannels(const CAEChannelInfo& rhs) const;
   void ReplaceChannel(const enum AEChannel from, const enum AEChannel to);
   int BestMatch(const std::vector<CAEChannelInfo>& dsts, int* score = NULL) const;

From eca7d9f09822dae0d05ed63426c9436896dc9b18 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Tue, 8 Aug 2017 21:12:34 +0200
Subject: [PATCH 2/2] AESinkALSA: Check layout for sanity

---
 xbmc/cores/AudioEngine/Sinks/AESinkALSA.cpp | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/xbmc/cores/AudioEngine/Sinks/AESinkALSA.cpp b/xbmc/cores/AudioEngine/Sinks/AESinkALSA.cpp
index d66993a09583..4d87afa2c94c 100644
--- a/xbmc/cores/AudioEngine/Sinks/AESinkALSA.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/AESinkALSA.cpp
@@ -618,6 +618,11 @@ bool CAESinkALSA::Initialize(AEAudioFormat &format, std::string &device)
   }
   // adjust format to the configuration we got
   format.m_channelLayout = GetChannelLayout(format, outconfig.channels);
+  // we might end up with an unusable channel layout that contains only UNKNOWN
+  // channels, let's do a sanity check.
+  if (!format.m_channelLayout.IsLayoutValid())
+    return false;
+
   format.m_sampleRate = outconfig.sampleRate;
   format.m_frames = outconfig.periodSize;
   format.m_frameSize = outconfig.frameSize;
